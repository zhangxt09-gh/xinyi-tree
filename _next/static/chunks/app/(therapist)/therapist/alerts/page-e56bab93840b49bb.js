(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[785],{34667:function(e,s,t){Promise.resolve().then(t.bind(t,90609))},90609:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return C}});var l=t(3827),a=t(64090),r=t(69724),n=t(62985),c=t(28814),i=t(29733),d=t(10775),o=t(27271),x=t(11213),m=t(26490),h=t(37805),u=t(52235),g=t(40834),y=t(43345),w=t(65404),b=t(34187),j=t(97307),p=t(69475);let f=t(49079).env.NEXT_PUBLIC_AI_ENGINE_URL||"http://localhost:8000/api/v1";async function N(e){let s=await fetch("".concat(f,"/therapist/alerts/dashboard?therapist_id=").concat(e));if(!s.ok)throw Error("Failed to fetch dashboard data");return s.json()}async function v(e){if(!(await fetch("".concat(f,"/therapist/alerts/").concat(e,"/acknowledge"),{method:"POST"})).ok)throw Error("Failed to acknowledge alert")}async function _(e,s){if(!(await fetch("".concat(f,"/therapist/alerts/").concat(e,"/resolve"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({resolution_notes:s})})).ok)throw Error("Failed to resolve alert")}function S(e){let{level:s}=e,{bg:t,text:a,border:i,icon:d,label:o}={red:{bg:"bg-red-100",text:"text-red-700",border:"border-red-200",icon:r.Z,label:"紧急"},yellow:{bg:"bg-yellow-100",text:"text-yellow-700",border:"border-yellow-200",icon:n.Z,label:"警告"},blue:{bg:"bg-blue-100",text:"text-blue-700",border:"border-blue-200",icon:c.Z,label:"提醒"}}[s];return(0,l.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ".concat(t," ").concat(a," border ").concat(i),children:[(0,l.jsx)(d,{className:"w-3 h-3"}),o]})}function k(e){let{title:s,value:t,icon:a,color:r,trend:n}=e,c="up"===n?i.Z:"down"===n?d.Z:o.Z,x="up"===n?"text-red-500":"down"===n?"text-green-500":"text-gray-400";return(0,l.jsx)("div",{className:"bg-white rounded-xl shadow-sm p-5 border-l-4 ".concat(r),children:(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"text-sm text-gray-500",children:s}),(0,l.jsx)("p",{className:"text-3xl font-bold mt-1",children:t})]}),(0,l.jsxs)("div",{className:"flex flex-col items-center gap-1",children:[(0,l.jsx)("div",{className:"p-3 rounded-full ".concat(r.replace("border-","bg-").replace("-500","-100")),children:(0,l.jsx)(a,{className:"w-6 h-6 ".concat(r.replace("border-","text-"))})}),n&&(0,l.jsx)(c,{className:"w-4 h-4 ".concat(x)})]})]})})}function D(e){let{alert:s,onAcknowledge:t,onResolve:r}=e,[n,c]=(0,a.useState)(!1),i=s.urgency_hours<=4?"text-red-600":s.urgency_hours<=24?"text-yellow-600":"text-gray-600",d=function(e){let s=Math.floor((new Date().getTime()-e.getTime())/6e4),t=Math.floor(s/60),l=Math.floor(t/24);return s<60?"".concat(s,"分钟前"):t<24?"".concat(t,"小时前"):l<7?"".concat(l,"天前"):e.toLocaleDateString("zh-CN")}(new Date(s.created_at));return(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border-l-4 p-4 hover:shadow-md transition-shadow ".concat("red"===s.level?"border-red-500":"yellow"===s.level?"border-yellow-500":"border-blue-500"),children:[(0,l.jsxs)("div",{className:"flex items-start justify-between",children:[(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,l.jsx)(S,{level:s.level}),(0,l.jsx)("span",{className:"text-xs text-gray-500",children:d})]}),(0,l.jsx)("h4",{className:"font-medium text-gray-900",children:s.title}),(0,l.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:s.description}),(0,l.jsxs)("div",{className:"flex items-center gap-4 mt-3 text-sm",children:[(0,l.jsxs)("span",{className:"flex items-center gap-1 text-gray-500",children:[(0,l.jsx)(x.Z,{className:"w-4 h-4"}),s.child_name]}),(0,l.jsxs)("span",{className:"flex items-center gap-1 ".concat(i),children:[(0,l.jsx)(m.Z,{className:"w-4 h-4"}),s.urgency_hours,"小时内处理"]})]})]}),(0,l.jsx)("button",{onClick:()=>c(!n),className:"p-1 hover:bg-gray-100 rounded",children:(0,l.jsx)(h.Z,{className:"w-5 h-5 text-gray-400 transition-transform ".concat(n?"rotate-90":"")})})]}),n&&(0,l.jsxs)("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[(0,l.jsx)("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"建议行动："}),(0,l.jsx)("ul",{className:"space-y-1 mb-4",children:s.recommended_actions.map((e,s)=>(0,l.jsxs)("li",{className:"text-sm text-gray-600 flex items-start gap-2",children:[(0,l.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-gray-400 mt-1.5 flex-shrink-0"}),e]},s))}),(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("button",{onClick:()=>t(s.id),className:"flex-1 px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",children:"已知悉"}),(0,l.jsx)("button",{onClick:()=>r(s.id),className:"flex-1 px-3 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors",children:"标记解决"})]})]})]})}function Z(e){let{data:s}=e;if(!s.length)return(0,l.jsx)("div",{className:"h-48 flex items-center justify-center text-gray-400",children:"暂无趋势数据"});let t=Math.max(...s.flatMap(e=>[e.red,e.yellow,e.blue]))||1;return(0,l.jsxs)("div",{className:"h-48",children:[(0,l.jsx)("div",{className:"flex items-end justify-between h-40 gap-2",children:s.map((e,s)=>{e.red,e.yellow,e.blue;let a=e.red/t*100,r=e.yellow/t*100,n=e.blue/t*100;return(0,l.jsxs)("div",{className:"flex-1 flex flex-col items-center gap-1",children:[(0,l.jsxs)("div",{className:"w-full flex flex-col-reverse h-32",children:[e.red>0&&(0,l.jsx)("div",{className:"w-full bg-red-400 rounded-t",style:{height:"".concat(a,"%")},title:"紧急: ".concat(e.red)}),e.yellow>0&&(0,l.jsx)("div",{className:"w-full bg-yellow-400",style:{height:"".concat(r,"%")},title:"警告: ".concat(e.yellow)}),e.blue>0&&(0,l.jsx)("div",{className:"w-full bg-blue-400",style:{height:"".concat(n,"%")},title:"提醒: ".concat(e.blue)})]}),(0,l.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.date).toLocaleDateString("zh-CN",{weekday:"short"})})]},s)})}),(0,l.jsxs)("div",{className:"flex items-center justify-center gap-4 mt-2",children:[(0,l.jsxs)("span",{className:"flex items-center gap-1 text-xs",children:[(0,l.jsx)("span",{className:"w-3 h-3 bg-red-400 rounded"})," 紧急"]}),(0,l.jsxs)("span",{className:"flex items-center gap-1 text-xs",children:[(0,l.jsx)("span",{className:"w-3 h-3 bg-yellow-400 rounded"})," 警告"]}),(0,l.jsxs)("span",{className:"flex items-center gap-1 text-xs",children:[(0,l.jsx)("span",{className:"w-3 h-3 bg-blue-400 rounded"})," 提醒"]})]})]})}function O(e){let{riskCase:s}=e,t=s.risk_score>=50?"text-red-600":s.risk_score>=20?"text-yellow-600":"text-blue-600";return(0,l.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsx)("div",{className:"w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm",children:(0,l.jsx)(x.Z,{className:"w-5 h-5 text-gray-400"})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-medium text-gray-900",children:s.child_name}),(0,l.jsxs)("p",{className:"text-xs text-gray-500",children:[s.age,"岁 \xb7 ",s.diagnosis||"未确诊"]})]})]}),(0,l.jsxs)("div",{className:"text-right",children:[(0,l.jsx)("p",{className:"font-bold ".concat(t),children:s.risk_score}),(0,l.jsxs)("p",{className:"text-xs text-gray-500",children:[s.red_alerts>0&&(0,l.jsxs)("span",{className:"text-red-500",children:[s.red_alerts,"紧急 "]}),s.yellow_alerts>0&&(0,l.jsxs)("span",{className:"text-yellow-500",children:[s.yellow_alerts,"警告"]})]})]})]})}function I(e){let{alertId:s,onClose:t,onResolve:r}=e,[n,c]=(0,a.useState)(""),[i,d]=(0,a.useState)(!1),o=async()=>{if(n.trim()){d(!0);try{await r(s,n),t()}finally{d(!1)}}};return(0,l.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,l.jsxs)("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-md p-6",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold",children:"标记预警为已解决"}),(0,l.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,l.jsx)(u.Z,{className:"w-5 h-5"})})]}),(0,l.jsx)("textarea",{value:n,onChange:e=>c(e.target.value),placeholder:"请输入处理记录...",className:"w-full h-32 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-500 resize-none"}),(0,l.jsxs)("div",{className:"flex gap-3 mt-4",children:[(0,l.jsx)("button",{onClick:t,className:"flex-1 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50",children:"取消"}),(0,l.jsx)("button",{onClick:o,disabled:!n.trim()||i,className:"flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50",children:i?"提交中...":"确认解决"})]})]})})}function C(){let[e,s]=(0,a.useState)(null),[t,i]=(0,a.useState)(!0),[d,o]=(0,a.useState)(null),[x,m]=(0,a.useState)("all"),[h,u]=(0,a.useState)(null),f="therapist_001",S=(0,a.useCallback)(async()=>{i(!0),o(null);try{let e=await N(f);s(e)}catch(e){o("加载数据失败，请稍后重试"),s({summary:{red:2,yellow:5,blue:8,total:15},alerts:[{id:"alert_001",case_id:"case_001",child_name:"小明",level:"red",type:"risk_keyword",title:"发现风险关键词：自伤",description:"在会话记录中发现可能的风险表述，需要关注。",created_at:new Date(Date.now()-72e5).toISOString(),urgency_hours:4,recommended_actions:["立即评估安全风险","必要时联系监护人","考虑转介专业危机干预"]},{id:"alert_002",case_id:"case_002",child_name:"小红",level:"red",type:"risk_behavior",title:"发现风险行为指标",description:"在第5次会话中发现以下风险指标：攻击性行为、情绪失控",created_at:new Date(Date.now()-18e6).toISOString(),urgency_hours:24,recommended_actions:["评估风险严重程度","考虑是否需要专业介入","与家长沟通"]},{id:"alert_003",case_id:"case_003",child_name:"小华",level:"yellow",type:"mood_decline",title:"情绪状态持续低落",description:"孩子连续3次会话表现出负面情绪，需要关注。",created_at:new Date(Date.now()-864e5).toISOString(),urgency_hours:48,recommended_actions:["评估是否存在外部压力源","调整疗愈策略","增加情绪支持活动"]},{id:"alert_004",case_id:"case_004",child_name:"小强",level:"yellow",type:"progress_stall",title:"疗愈进展停滞",description:"近4周进度分数无明显提升，建议评估调整疗愈方案。",created_at:new Date(Date.now()-1728e5).toISOString(),urgency_hours:72,recommended_actions:["回顾疗愈目标","与孩子沟通感受","考虑调整活动形式"]},{id:"alert_005",case_id:"case_005",child_name:"小美",level:"blue",type:"absence",title:"缺席提醒",description:"距离上次会话已超过2周，建议联系家长了解情况。",created_at:new Date(Date.now()-2592e5).toISOString(),urgency_hours:72,recommended_actions:["联系家长确认情况","安排补约时间"]}],trends:[{date:new Date(Date.now()-5184e5).toISOString(),red:1,yellow:2,blue:3},{date:new Date(Date.now()-432e6).toISOString(),red:0,yellow:3,blue:2},{date:new Date(Date.now()-3456e5).toISOString(),red:1,yellow:1,blue:4},{date:new Date(Date.now()-2592e5).toISOString(),red:2,yellow:2,blue:1},{date:new Date(Date.now()-1728e5).toISOString(),red:1,yellow:4,blue:3},{date:new Date(Date.now()-864e5).toISOString(),red:0,yellow:2,blue:5},{date:new Date().toISOString(),red:2,yellow:5,blue:8}],risk_cases:[{case_id:"case_001",child_name:"小明",age:8,diagnosis:"情绪障碍",alert_count:3,red_alerts:1,yellow_alerts:2,risk_score:50,last_session:new Date(Date.now()-1728e5).toISOString()},{case_id:"case_002",child_name:"小红",age:10,diagnosis:"行为问题",alert_count:2,red_alerts:1,yellow_alerts:1,risk_score:40,last_session:new Date(Date.now()-432e6).toISOString()},{case_id:"case_003",child_name:"小华",age:7,diagnosis:null,alert_count:2,red_alerts:0,yellow_alerts:2,risk_score:20,last_session:new Date(Date.now()-864e5).toISOString()}]})}finally{i(!1)}},[f]);(0,a.useEffect)(()=>{S()},[S]);let C=async t=>{try{await v(t),S()}catch(l){e&&s({...e,alerts:e.alerts.filter(e=>e.id!==t)})}},E=async(t,l)=>{try{await _(t,l),S()}catch(l){e&&s({...e,alerts:e.alerts.filter(e=>e.id!==t)})}},T=(null==e?void 0:e.alerts.filter(e=>"all"===x||e.level===x))||[];return t&&!e?(0,l.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,l.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,l.jsx)(g.Z,{className:"w-8 h-8 animate-spin text-secondary-500"}),(0,l.jsx)("p",{className:"text-gray-500",children:"加载中..."})]})}):(0,l.jsxs)("div",{className:"max-w-7xl mx-auto py-6 px-4",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"预警看板"}),(0,l.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"实时监控个案风险状态"})]}),(0,l.jsxs)("button",{onClick:S,disabled:t,className:"flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:[(0,l.jsx)(g.Z,{className:"w-4 h-4 ".concat(t?"animate-spin":"")}),"刷新"]})]}),d&&(0,l.jsxs)("div",{className:"mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700",children:[d,"（已加载模拟数据）"]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[(0,l.jsx)(k,{title:"紧急预警",value:(null==e?void 0:e.summary.red)||0,icon:r.Z,color:"border-red-500",trend:(null==e?void 0:e.summary.red)?"up":"stable"}),(0,l.jsx)(k,{title:"警告预警",value:(null==e?void 0:e.summary.yellow)||0,icon:n.Z,color:"border-yellow-500"}),(0,l.jsx)(k,{title:"提醒预警",value:(null==e?void 0:e.summary.blue)||0,icon:c.Z,color:"border-blue-500"}),(0,l.jsx)(k,{title:"待处理总数",value:(null==e?void 0:e.summary.total)||0,icon:y.Z,color:"border-gray-500"})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,l.jsx)("div",{className:"lg:col-span-2",children:(0,l.jsxs)("div",{className:"bg-white rounded-xl shadow-sm",children:[(0,l.jsxs)("div",{className:"px-5 py-4 border-b border-gray-100 flex items-center justify-between",children:[(0,l.jsxs)("h2",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[(0,l.jsx)(y.Z,{className:"w-5 h-5 text-secondary-500"}),"预警列表"]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)(w.Z,{className:"w-4 h-4 text-gray-400"}),(0,l.jsxs)("select",{value:x,onChange:e=>m(e.target.value),className:"text-sm border-0 focus:ring-0 text-gray-600",children:[(0,l.jsx)("option",{value:"all",children:"全部"}),(0,l.jsx)("option",{value:"red",children:"紧急"}),(0,l.jsx)("option",{value:"yellow",children:"警告"}),(0,l.jsx)("option",{value:"blue",children:"提醒"})]})]})]}),(0,l.jsx)("div",{className:"p-5 space-y-4 max-h-[600px] overflow-y-auto",children:0===T.length?(0,l.jsxs)("div",{className:"text-center py-12 text-gray-400",children:[(0,l.jsx)(b.Z,{className:"w-12 h-12 mx-auto mb-3"}),(0,l.jsx)("p",{children:"暂无预警信息"})]}):T.map(e=>(0,l.jsx)(D,{alert:e,onAcknowledge:C,onResolve:e=>u(e)},e.id))})]})}),(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"bg-white rounded-xl shadow-sm p-5",children:[(0,l.jsxs)("h2",{className:"font-semibold text-gray-900 flex items-center gap-2 mb-4",children:[(0,l.jsx)(j.Z,{className:"w-5 h-5 text-secondary-500"}),"7日趋势"]}),(0,l.jsx)(Z,{data:(null==e?void 0:e.trends)||[]})]}),(0,l.jsxs)("div",{className:"bg-white rounded-xl shadow-sm p-5",children:[(0,l.jsxs)("h2",{className:"font-semibold text-gray-900 flex items-center gap-2 mb-4",children:[(0,l.jsx)(p.Z,{className:"w-5 h-5 text-secondary-500"}),"高风险个案"]}),(0,l.jsx)("div",{className:"space-y-3",children:(null==e?void 0:e.risk_cases.length)===0?(0,l.jsx)("p",{className:"text-center py-6 text-gray-400",children:"暂无高风险个案"}):null==e?void 0:e.risk_cases.slice(0,5).map(e=>(0,l.jsx)(O,{riskCase:e},e.case_id))})]})]})]}),h&&(0,l.jsx)(I,{alertId:h,onClose:()=>u(null),onResolve:E})]})}}},function(e){e.O(0,[85,971,69,744],function(){return e(e.s=34667)}),_N_E=e.O()}]);